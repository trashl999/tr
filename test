--[[

	Universal Aimbot Module by Exunys
	FOV REMOVIDO
	ATIVA AO SEGURAR G

]]

--// Cache

local game, workspace = game, workspace
local getrawmetatable, setmetatable, pcall, getgenv, next =
	getrawmetatable, setmetatable, pcall, getgenv, next

local Vector2new, Vector3zero, CFramenew =
	Vector2.new, Vector3.zero, CFrame.new

local TweenInfonew = TweenInfo.new

local mousemoverel, tablefind, tableremove, stringlower, stringsub, mathclamp =
	mousemoverel or (Input and Input.MouseMove),
	table.find, table.remove, string.lower, string.sub, math.clamp

--// Metatable

local GameMetatable = getrawmetatable and getrawmetatable(game) or {
	__index = function(self, k) return self[k] end,
	__newindex = function(self, k, v) self[k] = v end
}

local __index = GameMetatable.__index
local __newindex = GameMetatable.__newindex
local GetService = __index(game, "GetService")

--// Services

local RunService = GetService(game, "RunService")
local UserInputService = GetService(game, "UserInputService")
local TweenService = GetService(game, "TweenService")
local Players = GetService(game, "Players")

--// Methods

local LocalPlayer = __index(Players, "LocalPlayer")
local Camera = __index(workspace, "CurrentCamera")

local FindFirstChild = __index(game, "FindFirstChild")
local FindFirstChildOfClass = __index(game, "FindFirstChildOfClass")
local GetDescendants = __index(game, "GetDescendants")
local WorldToViewportPoint = __index(Camera, "WorldToViewportPoint")
local GetPartsObscuringTarget = __index(Camera, "GetPartsObscuringTarget")
local GetMouseLocation = __index(UserInputService, "GetMouseLocation")
local GetPlayers = __index(Players, "GetPlayers")

--// Vars

local RequiredDistance = 2000
local Typing = false
local Running = false
local ServiceConnections = {}
local Animation
local OriginalSensitivity

local Connect = __index(game, "DescendantAdded").Connect
local Disconnect

--// Prevent duplicate

if ExunysDeveloperAimbot and ExunysDeveloperAimbot.Exit then
	ExunysDeveloperAimbot:Exit()
end

--// Environment

getgenv().ExunysDeveloperAimbot = {

	DeveloperSettings = {
		UpdateMode = "RenderStepped",
		TeamCheckOption = "TeamColor"
	},

	Settings = {
		Enabled = true,

		TeamCheck = false,
		AliveCheck = true,
		WallCheck = false,

		OffsetToMoveDirection = false,
		OffsetIncrement = 15,

		Sensitivity = 0,
		Sensitivity2 = 3.5,

		LockMode = 1,
		LockPart = "Head",

		TriggerKey = Enum.KeyCode.G,
		Toggle = false
	},

	Blacklisted = {}
}

local Environment = getgenv().ExunysDeveloperAimbot

--// Core

local FixUsername = function(str)
	for _, p in next, GetPlayers(Players) do
		local n = __index(p, "Name")
		if stringsub(stringlower(n), 1, #str) == stringlower(str) then
			return n
		end
	end
end

local ConvertVector = function(v)
	return Vector2new(v.X, v.Y)
end

local CancelLock = function()
	Environment.Locked = nil
	__newindex(UserInputService, "MouseDeltaSensitivity", OriginalSensitivity)
	if Animation then Animation:Cancel() end
end

local GetClosestPlayer = function()
	local S = Environment.Settings
	local PartName = S.LockPart

	if not Environment.Locked then
		RequiredDistance = 2000

		for _, plr in next, GetPlayers(Players) do
			local Char = __index(plr, "Character")
			local Hum = Char and FindFirstChildOfClass(Char, "Humanoid")

			if plr ~= LocalPlayer
				and not tablefind(Environment.Blacklisted, __index(plr, "Name"))
				and Char and FindFirstChild(Char, PartName) and Hum then

				if S.TeamCheck and
					__index(plr, Environment.DeveloperSettings.TeamCheckOption)
					== __index(LocalPlayer, Environment.DeveloperSettings.TeamCheckOption) then
					continue
				end

				if S.AliveCheck and __index(Hum, "Health") <= 0 then
					continue
				end

				if S.WallCheck then
					local blk = GetDescendants(__index(LocalPlayer, "Character"))
					for _, v in next, GetDescendants(Char) do
						blk[#blk+1] = v
					end
					if #GetPartsObscuringTarget(Camera,
						{ __index(Char[PartName], "Position") }, blk) > 0 then
						continue
					end
				end

				local vec, onscreen =
					WorldToViewportPoint(Camera, __index(Char[PartName], "Position"))

				local dist =
					(GetMouseLocation(UserInputService) - ConvertVector(vec)).Magnitude

				if dist < RequiredDistance and onscreen then
					RequiredDistance = dist
					Environment.Locked = plr
				end
			end
		end
	else
		local pos =
			WorldToViewportPoint(Camera,
				__index(__index(Environment.Locked, "Character")[PartName], "Position"))

		if (GetMouseLocation(UserInputService) - ConvertVector(pos)).Magnitude > RequiredDistance then
			CancelLock()
		end
	end
end

local Load = function()
	OriginalSensitivity = __index(UserInputService, "MouseDeltaSensitivity")
	local S = Environment.Settings

	ServiceConnections.RenderSteppedConnection =
		Connect(__index(RunService, Environment.DeveloperSettings.UpdateMode), function()

			if Running and S.Enabled then
				GetClosestPlayer()

				if Environment.Locked then
					local Char = __index(Environment.Locked, "Character")
					local Part = __index(Char, S.LockPart)

					local Offset =
						S.OffsetToMoveDirection
						and __index(FindFirstChildOfClass(Char, "Humanoid"), "MoveDirection")
						* (mathclamp(S.OffsetIncrement, 1, 30) / 10)
						or Vector3zero

					local Target = Part.Position + Offset
					local Screen = WorldToViewportPoint(Camera, Target)

					if S.LockMode == 2 then
						mousemoverel(
							(Screen.X - GetMouseLocation(UserInputService).X) / S.Sensitivity2,
							(Screen.Y - GetMouseLocation(UserInputService).Y) / S.Sensitivity2
						)
					else
						if S.Sensitivity > 0 then
							Animation = TweenService:Create(
								Camera,
								TweenInfonew(S.Sensitivity, Enum.EasingStyle.Sine, Enum.EasingDirection.Out),
								{ CFrame = CFramenew(Camera.CFrame.Position, Target) }
							)
							Animation:Play()
						else
							__newindex(Camera, "CFrame",
								CFramenew(Camera.CFrame.Position, Target))
						end
						__newindex(UserInputService, "MouseDeltaSensitivity", 0)
					end
				end
			end
		end)

	ServiceConnections.InputBeganConnection =
		Connect(__index(UserInputService, "InputBegan"), function(Input)
			if Typing then return end
			if Input.KeyCode == S.TriggerKey then
				Running = true
			end
		end)

	ServiceConnections.InputEndedConnection =
		Connect(__index(UserInputService, "InputEnded"), function(Input)
			if Typing then return end
			if Input.KeyCode == S.TriggerKey then
				Running = false
				CancelLock()
			end
		end)
end

--// Typing

ServiceConnections.TypingStartedConnection =
	Connect(__index(UserInputService, "TextBoxFocused"), function()
		Typing = true
	end)

ServiceConnections.TypingEndedConnection =
	Connect(__index(UserInputService, "TextBoxFocusReleased"), function()
		Typing = false
	end)

--// API

function Environment.Exit(self)
	for _, c in next, ServiceConnections do
		Disconnect(c)
	end
	getgenv().ExunysDeveloperAimbot = nil
end

function Environment.Blacklist(self, u)
	u = FixUsername(u)
	self.Blacklisted[#self.Blacklisted+1] = u
end

function Environment.Whitelist(self, u)
	u = FixUsername(u)
	local i = tablefind(self.Blacklisted, u)
	if i then tableremove(self.Blacklisted, i) end
end

function Environment.GetClosestPlayer()
	GetClosestPlayer()
	local v = Environment.Locked
	CancelLock()
	return v
end

Environment.Load = Load
setmetatable(Environment, { __call = Load })

return Environment
